线程安全需要保证几个基本特性：

- 原子性，简单说就是相关操作不会中途被其他线程干扰，一般通过同步机制实现。
- 可见性，是一个线程修改了某个共享变量，其状态能够立即被其他线程知晓，通常被解释为 将线程本地状态反映到主内存上，volatile 就是负责保证可见性的。
- 有序性，是保证线程内串行语义，避免指令重排等。

# 1.基础知识

## 1.线程安全性

### 1.1什么是线程安全性

### 1.2原子性

### 1.3加锁机制

### 1.4用锁来保护状态

### 1.5活跃与性能

## 2.对象的共享

2.1可见性

2.2发布与溢出

2.3线程封闭

2.4不变性

2.5安全发布

竞态条件：由于不恰当的执行时序而出现不正确的结果

当某个计算的正确性取决于多个线程的交替执行时序时：会发生竞态条件

1. 最常见的竞态条件类型是：先检查后执行
2. 读取-修改-写入(统计命中计数)

加锁：java中确保原子性的内置机制。每个对象都可以是锁：内置锁、监视器锁。

内置锁相当于一个互斥锁

线程安全类：AtomicLong，只有一个变量的时候好用

锁能使得保护的代码路径以串行访问，可以通过锁构造一些协议实现对共享状态的独占访问

# 如何实现一个Immutable类

Java 语言目前并没有原生的不可变支 持，如果要实现 immutable 的类，我们需要做到：

- 将 class 自身声明为 final，这样别人就不能扩展来绕过限制了。
- 将所有成员变量定义为 private 和 final，并且不要实现 setter 方法。
- 通常构造对象时，成员变量使用深度拷贝来初始化，而不是直接赋值，这是一种防御措施， 因为你无法确定输入对象不被其他人修改。
- 如果确实需要实现 getter 方法，或者其他可能会返回内部状态的方法，使用 copy-on-write 原则，创建私有的 copy。